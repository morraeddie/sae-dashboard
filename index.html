<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>SAE Registro Civil — Available Dates</title>
<style>
  * { margin: 0; padding: 0; box-sizing: border-box; }
  body {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    background: #0f172a;
    color: #e2e8f0;
    min-height: 100vh;
    padding: 2rem;
  }
  .header {
    text-align: center;
    margin-bottom: 2rem;
  }
  .header h1 {
    font-size: 1.8rem;
    font-weight: 700;
    margin-bottom: 0.5rem;
  }
  .status-bar {
    display: flex;
    justify-content: center;
    gap: 2rem;
    flex-wrap: wrap;
    margin-bottom: 2rem;
  }
  .status-item {
    background: #1e293b;
    padding: 0.75rem 1.5rem;
    border-radius: 0.5rem;
    font-size: 0.9rem;
  }
  .status-item .label { color: #94a3b8; }
  .status-item .value { color: #f1f5f9; font-weight: 600; }
  .status-item .value.ok { color: #4ade80; }
  .status-item .value.error { color: #f87171; }
  .calendars {
    display: flex;
    justify-content: center;
    gap: 2rem;
    flex-wrap: wrap;
  }
  .calendar {
    background: #1e293b;
    border-radius: 0.75rem;
    padding: 1.5rem;
    min-width: 320px;
  }
  .calendar-title {
    text-align: center;
    font-size: 1.1rem;
    font-weight: 600;
    margin-bottom: 1rem;
    color: #f1f5f9;
  }
  .weekdays {
    display: grid;
    grid-template-columns: repeat(7, 1fr);
    gap: 4px;
    margin-bottom: 4px;
  }
  .weekday {
    text-align: center;
    font-size: 0.75rem;
    font-weight: 600;
    color: #64748b;
    padding: 0.25rem;
  }
  .days {
    display: grid;
    grid-template-columns: repeat(7, 1fr);
    gap: 4px;
  }
  .day {
    text-align: center;
    padding: 0.5rem;
    border-radius: 0.375rem;
    font-size: 0.9rem;
    color: #475569;
  }
  .day.current-month { color: #94a3b8; }
  .day.today {
    border: 2px solid #3b82f6;
    color: #e2e8f0;
  }
  .day.available {
    background: #166534;
    color: #4ade80;
    font-weight: 700;
    cursor: pointer;
  }
  .day.available:hover {
    background: #15803d;
  }
  .legend {
    display: flex;
    justify-content: center;
    gap: 1.5rem;
    margin-top: 2rem;
    font-size: 0.85rem;
    color: #94a3b8;
  }
  .legend-item {
    display: flex;
    align-items: center;
    gap: 0.4rem;
  }
  .legend-dot {
    width: 12px;
    height: 12px;
    border-radius: 3px;
  }
  .legend-dot.available { background: #166534; }
  .legend-dot.today { border: 2px solid #3b82f6; }
  .error-banner {
    background: #7f1d1d;
    color: #fca5a5;
    padding: 0.75rem 1.5rem;
    border-radius: 0.5rem;
    text-align: center;
    margin-bottom: 1.5rem;
    display: none;
  }
  .dates-count {
    font-size: 2.5rem;
    font-weight: 800;
    color: #4ade80;
  }
</style>
</head>
<body>

<div class="header">
  <h1>SAE Registro Civil</h1>
  <p style="color:#94a3b8">Appointment availability monitor</p>
</div>

<div class="error-banner" id="errorBanner"></div>

<div class="status-bar">
  <div class="status-item">
    <span class="label">Available dates: </span>
    <span class="value ok" id="dateCount">—</span>
  </div>
  <div class="status-item">
    <span class="label">Last updated: </span>
    <span class="value" id="lastUpdated">—</span>
  </div>
  <div class="status-item">
    <span class="label">Status: </span>
    <span class="value ok" id="statusText">Loading...</span>
  </div>
</div>

<div class="calendars" id="calendars"></div>

<div class="legend">
  <div class="legend-item">
    <div class="legend-dot available"></div>
    <span>Available</span>
  </div>
  <div class="legend-item">
    <div class="legend-dot today"></div>
    <span>Today</span>
  </div>
</div>

<script>
// CONFIGURE: Set your Gist ID here after first bot run
const GIST_ID = 'c6c50cb1c22268cfb0fccd8f27047ca4';
const STATUS_URL_LOCAL = 'data/status.json';
const REFRESH_INTERVAL = 60_000;

function getStatusUrl() {
  if (GIST_ID) {
    return `https://api.github.com/gists/${GIST_ID}`;
  }
  return null;
}
const MONTH_NAMES = [
  'January','February','March','April','May','June',
  'July','August','September','October','November','December'
];
const WEEKDAYS = ['Mon','Tue','Wed','Thu','Fri','Sat','Sun'];

function parseDate(dateStr) {
  // Format: "D/M/YYYY"
  const parts = dateStr.split('/');
  if (parts.length !== 3) return null;
  const [d, m, y] = parts.map(Number);
  return new Date(y, m - 1, d);
}

function isSameDay(a, b) {
  return a.getFullYear() === b.getFullYear()
    && a.getMonth() === b.getMonth()
    && a.getDate() === b.getDate();
}

function timeAgo(isoString) {
  const then = new Date(isoString);
  const now = new Date();
  const diffMs = now - then;
  const mins = Math.floor(diffMs / 60000);
  if (mins < 1) return 'just now';
  if (mins < 60) return mins + ' min ago';
  const hrs = Math.floor(mins / 60);
  if (hrs < 24) return hrs + 'h ' + (mins % 60) + 'm ago';
  return then.toLocaleString();
}

function getMonthsToShow(availableDates) {
  const now = new Date();
  const months = new Set();
  months.add(`${now.getFullYear()}-${now.getMonth()}`);

  for (const d of availableDates) {
    const parsed = parseDate(d);
    if (parsed) months.add(`${parsed.getFullYear()}-${parsed.getMonth()}`);
  }

  return Array.from(months)
    .map(s => { const [y, m] = s.split('-').map(Number); return { year: y, month: m }; })
    .sort((a, b) => a.year - b.year || a.month - b.month);
}

function renderCalendar(year, month, availableSet) {
  const today = new Date();
  const firstDay = new Date(year, month, 1);
  // Monday-based: 0=Mon, 6=Sun
  let startDow = (firstDay.getDay() + 6) % 7;
  const daysInMonth = new Date(year, month + 1, 0).getDate();

  let html = `<div class="calendar">`;
  html += `<div class="calendar-title">${MONTH_NAMES[month]} ${year}</div>`;
  html += `<div class="weekdays">`;
  for (const wd of WEEKDAYS) html += `<div class="weekday">${wd}</div>`;
  html += `</div><div class="days">`;

  // Empty cells before first day
  for (let i = 0; i < startDow; i++) html += `<div class="day"></div>`;

  for (let d = 1; d <= daysInMonth; d++) {
    const date = new Date(year, month, d);
    const dateKey = `${d}/${month + 1}/${year}`;
    const isToday = isSameDay(date, today);
    const isAvailable = availableSet.has(dateKey);

    let cls = 'day current-month';
    if (isToday) cls += ' today';
    if (isAvailable) cls += ' available';

    html += `<div class="${cls}">${d}</div>`;
  }

  html += `</div></div>`;
  return html;
}

async function fetchData() {
  // Try Gist API first
  const gistUrl = getStatusUrl();
  if (gistUrl) {
    const resp = await fetch(gistUrl, {
      headers: { 'Accept': 'application/vnd.github.v3+json' }
    });
    if (resp.ok) {
      const gist = await resp.json();
      return JSON.parse(gist.files['status.json'].content);
    }
  }
  // Fallback to local file
  const resp = await fetch(STATUS_URL_LOCAL + '?t=' + Date.now());
  if (!resp.ok) throw new Error('No data source available');
  return await resp.json();
}

async function loadAndRender() {
  try {
    const data = await fetchData();

    // Update status bar
    document.getElementById('dateCount').textContent = data.available_dates.length;
    _lastUpdatedIso = data.last_updated;
    document.getElementById('lastUpdated').textContent = timeAgo(data.last_updated);

    if (data.last_error) {
      document.getElementById('statusText').textContent = 'Error';
      document.getElementById('statusText').className = 'value error';
      document.getElementById('errorBanner').textContent = data.last_error;
      document.getElementById('errorBanner').style.display = 'block';
    } else {
      document.getElementById('statusText').textContent = 'OK';
      document.getElementById('statusText').className = 'value ok';
      document.getElementById('errorBanner').style.display = 'none';
    }

    // Build set of available dates
    const availableSet = new Set(data.available_dates);

    // Determine which months to render
    const months = getMonthsToShow(data.available_dates);

    // Render calendars
    let html = '';
    for (const { year, month } of months) {
      html += renderCalendar(year, month, availableSet);
    }
    document.getElementById('calendars').innerHTML = html;

  } catch (e) {
    document.getElementById('statusText').textContent = 'No data yet';
    document.getElementById('statusText').className = 'value error';
  }
}

let _lastUpdatedIso = null;
async function refreshTimeAgo() {
  if (_lastUpdatedIso) {
    document.getElementById('lastUpdated').textContent = timeAgo(_lastUpdatedIso);
  }
}

loadAndRender();
setInterval(loadAndRender, REFRESH_INTERVAL);
setInterval(refreshTimeAgo, 30_000);
</script>
</body>
</html>
